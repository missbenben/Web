
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">

    <script type="text/javascript" src="http://www.xdocin.com/xdoc.js"></script>
    <script type="text/javascript" src="http://www.xdocin.com/baiduTemplate.js"></script>
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
</head>
<body>
    <div id="wzw"></div>
    <input type="button" onclick="gen1('pdf')" value="生成PDF1" />
    <input type="button" onclick="gen2('pdf')" value="生成PDF1" />
    <input type="button" onclick="gen1('docx')" value="生成Word1" />
    <input type="button" onclick="gen2('docx')" value="生成Word2" />
    <div id="wzwImg" style="display:none"></div>
    <img src="#" alt="" crossorigin="anonymous" />
    <br />
    <script id="tmpl" type="text/html">
        <xdoc version="11.3.0">
	  <meta modifyDate="2017-11-08 11:07:56" author="7" id="5bkwrxd5nbhjthchu4a7n3uchi" createDate="2017-11-08 10:57:37"/>
	  <body>
	    <para align="center">
	      <text><%=title%></text>
	    </para>
	    <para align="center"/>
	    <para align="center">
	      <table merge="false" height="884" name="x1786" header="1" cols="82,82,82,82,82,82,106" rows="40,32,36,632,142" width="600">
	        <cell col="1" name="x1789" row="1" colSpan="2">
	          <para align="center" lineSpacing="4">
	            <text>项目名称</text>
	          </para>
	        </cell>
	        <cell col="3" name="x1791" row="1" colSpan="5">
	          <para align="center">
	            <text><%=ripName%></text>
	          </para>
	        </cell>
	        <rect col="1" row="2" colSpan="2" name="x210">
	          <para align="center" lineSpacing="4">
	            <text>报告所属事项</text>
	          </para>
	        </rect>
	        <cell col="3" name="x1798" row="2" colSpan="5">
	          <para align="center">
	            <text><%=matterCenter%></text>
	          </para>
	        </cell>
	        <rect col="1" row="3" name="x230">
	          <para align="center" lineSpacing="4">
	            <text>报告人：</text>
	          </para>
	        </rect>
	        <cell col="2" name="x1804" row="3">
	          <para align="center">
	            <text valign="center"><%=reportName%></text>
	          </para>
	        </cell>
	        <rect col="3" row="3" name="x250">
	          <para align="center" lineSpacing="4">
	            <text>提交报告：</text>
	          </para>
	        </rect>
	        <cell col="4" name="x1806" row="3">
	          <para align="center" lineSpacing="4">
	            <text valign="center"><%=reportTime%></text>
	          </para>
	        </cell>
	        <rect col="5" row="3" name="x286">
	          <para align="center" lineSpacing="4">
	            <text>报告周期：</text>
	          </para>
	        </rect>
	        <cell col="6" name="x1808" row="3" colSpan="2">
	          <para align="center">
	            <text valign="center"><%=reportTimeEnd%></text>
	          </para>
	        </cell>
	        <cell col="1" name="x1810" row="4" colSpan="7">
	          <para lineSpacing="4">
	            <text>汇报说明</text>
	          </para>
	          <para lineSpacing="4">
	            <text><%=content%></text>
	          </para>
	          <para lineSpacing="4"/>
	          <para lineSpacing="4"/>
              <%if(imgItems.length>0){%>
	              <para lineSpacing="4">
                    <%for(var i=0;i<data.imgItems.length;i++){%>
	                    <img height="194" src="<%=wzwimg%>" name="x760" width="250"/>
                    <%}%>
	              </para>
              <%}else{%>
                <para lineSpacing="4">
                 <text>无图片信息</text>
                </para>
              <%}%>
	          <para lineSpacing="4"/>
	          <para lineSpacing="4"/>
	          <para lineSpacing="4">
	            <text>汇报条目：</text>
	          </para>
            <%if(entryItems.length>0){%>
                <%for(var i=0;i<entryItems.length;i++){%>
	               <para indent="24" lineSpacing="4">
	                     <text><%=i+1%>、 条目名称：<%=entryItems[i].ERI_CheckContent%></text>
	                </para>
	                <para indent="24" lineSpacing="4">
	                    <text>	条目说明：<%=entryItems[i].ERI_CheckResult%></text>
	                </para>
	                <para indent="24" lineSpacing="4">
	                    <text>	条目范围：<%=entryItems[i].ERI_BuildingStr%></text>
	                </para>
	                <para indent="24" lineSpacing="4">
	                     <text>	包含附件：检查结果<%=entryItems[i].RipNum%>个；文件<%=entryItems[i].PicNum%>个；图片<%=entryItems[i].PicNum%>张</text>
	                </para>
                <%}%>
            <%}else{%>
                <para lineSpacing="4">
                 <text>无条目信息</text>
                </para>
            <%}%>
            </cell>
	        <cell col="1" name="x1817" row="5" colSpan="7">
	          <para align="right" lineSpacing="4"/>
	          <para align="right" lineSpacing="4"/>
	          <para align="right" lineSpacing="4">
	            <text>导出人： 姓名</text>
	          </para>
	          <para align="right" lineSpacing="4">
	            <text>导出时间：2017年8月10日</text>
	          </para>
	        </cell>
	      </table>
	    </para>
	  </body>
	</xdoc>
    </script>
        <script type="text/javascript">
            var urls = '@(ViewData["ImageShow"])'
            var data = {
                title: "",
                ripName: '',
                reportName: '',
                reportTime: '',
                reportTimeEnd: '',
                matterCenter: '',
                content: "",
                imgItems: [],
                entryItems: [],
                wzwimg:'https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=4183310167,1889267758&fm=27&gp=0.jpg'
            };
            //var imgNub = 0
            //function getBase64(url) {
            //    //通过构造函数来创建的 img 实例，在赋予 src 值后就会立刻下载图片，相比 createElement() 创建 <img> 省去了 append()，也就避免了文档冗余和污染
            //    var Img = new Image(),
            //        dataURL = '';
            //    Img.crossOrigin = 'Anonymous'
            //    Img.src = url;
            //    Img.onload = function () { //要先确保图片完整获取到，这是个异步事件
            //        var canvas = document.createElement("canvas"), //创建canvas元素
            //            width = Img.width, //确保canvas的尺寸和图片一样
            //            height = Img.height;
            //        canvas.width = width;
            //        canvas.height = height;
            //        canvas.getContext("2d").drawImage(Img, 0, 0, width, height); //将图片绘制到canvas中
            //        dataURL = canvas.toDataURL('image/jpeg'); //转换图片为dataURL
            //        data.imgItems.push(dataURL)
            //        imgNub += 1
            //        if (imgNub == data.imgItems.length) {
            //            XDoc.to(baidu.template('tmpl', data), format, {}, "_self");
            //        }
            //    };
            //}
            var judgeNub = 0, arrLength = 0;
            function getBase64Image(img) {
                img.crossOrigin = '*'
                var canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;
                var ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, img.width, img.height);
                dataURL = canvas.toDataURL('image/jpeg')
                judgeNub += 1
                if (arrLength == judgeNub) {
                    setTimeout(function () {
                        XDoc.to(baidu.template('tmpl', data), 'docx', {}, "_self");
                    },1000)
                    
                }
                return dataURL;
            }
            //var img = 'http://192.168.1.65:8910/f80621e6-918a-4b07-8c97-5533e674f093/CheckFile/20171108/a070810a-45bd-4dfb-a25d-012148b430c9.jpg'
            //$('img').attr('src', img)
            //$('img')[0].onload = function () {
            //    var base64 = getBase64Image($('img')[0]);
            //    console.log(base64);
            //}
            
          function gen1(format) {
              
              $.post('/Pro_File/GetReportUrlList', { ER_Guid: 'DA1B623C-E133-C95F-A9B5-E21DA5515363' }, function (rep1) {//图片
                  console.log(rep1.list.Table)
                  var rep1 = rep1.list.Table
                  arrLength = rep1.length
                  if (rep1.length > 0) {
                      //var imgI = ''
                      //rep1.forEach(function (rep) {
                      //    imgI += '<img src="' + urls + rep.PF_Url +'" alt="" crossorigin="anonymous" />'
                          
                      //})
                      //$('#wzwImg').html(imgI)
                      //$('#wzwImg img').each(function (index,el) {
                      //    console.log($(this)[0])
                      //    $(this).load(function () {
                      //        data.imgItems.push(getBase64Image($(this)[0]))
                              
                      //    })
                          
                      //})
                      rep1.forEach(function (rep) {
                          data.imgItems.push(window.urls + rep.PF_Url)
                          console.log(window.urls +rep.PF_Url)
                      })
                  }
                  $.post('/Pro_File/GetReportItemList', { ER_Guid: 'DA1B623C-E133-C95F-A9B5-E21DA5515363' }, function (rep2) {//list
                      console.log(rep2.list.Table)
                      var rep2 = rep2.list.Table
                      data.entryItems = rep2
                      $.post('/Pro_File/GetReport', { ER_Guid: 'DA1B623C-E133-C95F-A9B5-E21DA5515363' }, function (rep3) {//表头
                          console.log(rep3.list.Table[0])
                          var rep3 = rep3.list.Table[0]
                          data.ripName = rep3.P_Name
                          data.title = rep3.ER_Title;
                          data.reportName = rep3.User_Name
                          data.matterCenter = rep3.Evt_Name
                          data.content = rep3.ER_Summary
                          data.reportTime = rep3.ER_CreateDate.split('T')[0]
                          data.reportTimeEnd = rep3.ER_StartTime.split('T')[0].toString() + '-' + rep3.ER_EndTime.split('T')[0]
                          XDoc.to(baidu.template('tmpl', data), format, { "_filename": "hello" }, "_self");
                      }, 'json')
                  }, 'json')
              }, 'json')



        }
        </script>
</body>
</html>  
